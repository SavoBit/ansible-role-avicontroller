---
# check system against minimum requirements
- name: Avi Controller | Requirements | Check for netstat
  shell: "which netstat"
  failed_when: false
  changed_when: false
  register: netstat

- name: Avi Controller | Requirements | Check for ip addr
  shell: "which ip"
  register: ip_addr
  failed_when: false
  changed_when: false
  when: netstat.rc == 1

- name: Avi Controller | Requirements | Get the management device name | netstat
  shell: "netstat -ie | grep -B1 {{ controller_ip }} | head -n1 | awk -F ':' '{print $1}'"
  register: mgmt_device
  changed_when: false
  when: netstat.rc == 0

- name: Avi Controller | Requirements | Get the management device name | ip addr
  shell: "ip addr show | grep {{ controller_ip }} | awk '{print $8}'"
  register: mgmt_device
  changed_when: false
  when: ip_addr.rc == 0

- name: Avi Controller | Requirements | Set the management device name
  set_fact:
    dev_name: "{{ mgmt_device.stdout }}"
  when: mgmt_device

- name: Avi Controller | Requirements | Set maximum core count
  set_fact:
    max_cores: "{{ ansible_processor_cores * ansible_processor_count }}"

- name: Avi Controller | Requirements | Controller needs more than 4 cores.
  assert:
    that:
      - "max_cores >= 4"
      - "con_cores <= max_cores"

- name: Avi Controller | Requirements | Set the ansible_memtotal_gb var
  set_fact:
    ansible_memtotal_gb: "{{ ansible_memtotal_mb // 1024 }}"

- name: Avi Controller | Requirements | Controller needs between 12GB and {{ ansible_memtotal_mb // 1024 }}GB memory.
  assert:
    that:
      - "ansible_memtotal_mb >= 12288"
      - "con_memory_gb <= ansible_memtotal_gb"

- name: Avi Controller | Requirements | Clean directories for fresh install
  file: path="{{ item }}" state=absent
  when: item != None and fresh_install
  with_items:
    - "{{ con_disk_path }}"
    - "{{ con_metrics_disk_path }}"
    - "{{ con_logs_disk_path }}"

- name: Avi Controller | Requirements | Create directories for controller
  file: path="{{ item }}" state=directory mode=0755
  when: item != None
  with_items:
    - "{{ con_disk_path }}"
    - "{{ con_metrics_disk_path }}"
    - "{{ con_logs_disk_path }}"

- block:
    - name: Avi Controller | Requirements | Get disk space on controller disk path
      shell: "df {{ con_disk_path }} -BG | grep -iv Used | awk '{print $4}' | sed s/G//g"
      changed_when: false
      register: con_disk_path_space
    - name: Avi Controller | Requirements | Check if there is enough space for controller disk path
      assert:
        that:
          - con_disk_gb != None
          - con_disk_path_space.stdout > con_disk_gb
  when: con_disk_path != None

- block:
    - name: Avi Controller | Requirements | Get disk space on controller metrics disk path
      shell: "df {{ con_metrics_disk_path }} -BG | grep -iv Used | awk '{print $4}' | sed s/G//g"
      register: con_metrics_disk_path_space
    - name: Avi Controller | Requirements | Check if there is enough space for controller metrics disk path
      assert:
        that:
          - con_metrics_disk_gb != None
          - con_metrics_disk_path_space.stdout > con_metrics_disk_gb
  when: con_metrics_disk_path != None

- block:
    - name: Avi Controller | Requirements | Get disk space on controller logs disk path
      shell: "df {{ con_logs_disk_path }} -BG | grep -iv Used | awk '{print $4}' | sed s/G//g"
      register: con_logs_disk_path_space
    - name: Avi Controller | Requirements | Check if there is enough space for controller logs disk path
      assert:
        that:
          - con_logs_disk_gb != None
          - con_logs_disk_path_space.stdout > con_logs_disk_gb
  when: con_logs_disk_path != None
